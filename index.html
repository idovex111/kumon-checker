<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kumon Homework Checker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Improve touch behavior on mobile */
        * {
            -webkit-tap-highlight-color: transparent;
        }
        
        button, input[type="file"] + label {
            touch-action: manipulation;
            -webkit-touch-callout: none;
            user-select: none;
        }
        
        /* Ensure buttons have enough touch target size */
        button {
            min-height: 44px;
            min-width: 44px;
        }
        
        /* Prevent text selection on double tap */
        .touch-manipulation {
            touch-action: manipulation;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-50 min-h-screen p-4">
    <!-- API Key Setup Modal -->
    <div id="apiKeyModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-6 sm:p-8 max-w-md w-full mx-4">
            <h2 class="text-xl sm:text-2xl font-bold text-gray-900 mb-3 sm:mb-4">Setup Required</h2>
            <p class="text-sm sm:text-base text-gray-600 mb-4">To use this app, you need a Claude API key from Anthropic.</p>
            
            <div class="bg-blue-50 border-l-4 border-blue-500 p-3 sm:p-4 mb-4">
                <p class="text-xs sm:text-sm text-blue-800">
                    <strong>How to get your API key:</strong><br>
                    1. Go to <a href="https://console.anthropic.com" target="_blank" class="underline">console.anthropic.com</a><br>
                    2. Sign up or log in<br>
                    3. Go to API Keys<br>
                    4. Create a new key<br>
                    5. Paste it below
                </p>
            </div>
            
            <label class="block text-sm font-semibold text-gray-700 mb-2">Your Claude API Key</label>
            <input type="password" id="apiKeyInput" placeholder="sk-ant-..." 
                   class="w-full px-3 sm:px-4 py-2 sm:py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 mb-4 text-sm sm:text-base">
            
            <button onclick="saveApiKey()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 sm:py-3 px-4 sm:px-6 rounded-lg transition-colors text-sm sm:text-base">
                Save & Start
            </button>
            
            <p class="text-xs text-gray-500 mt-3 sm:mt-4">
                Your API key is stored locally in your browser and only sent to Anthropic's API.
            </p>
        </div>
    </div>

    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-4 sm:p-8 mb-6">
            <!-- Settings Button -->
            <div class="flex justify-end mb-2 sm:mb-4">
                <button onclick="openSettings()" class="text-gray-600 hover:text-gray-800 flex items-center gap-1 sm:gap-2 text-xs sm:text-sm touch-manipulation">
                    <svg class="w-4 h-4 sm:w-5 sm:h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    API Settings
                </button>
            </div>
            <div class="flex flex-col sm:flex-row items-center gap-4 mb-4">
                <svg width="60" height="60" viewBox="0 0 400 400" xmlns="http://www.w3.org/2000/svg" class="flex-shrink-0">
                  <defs>
                    <linearGradient id="mainGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#4F46E5;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#7C3AED;stop-opacity:1" />
                    </linearGradient>
                    <linearGradient id="checkGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#10B981;stop-opacity:1" />
                      <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                    </linearGradient>
                    <filter id="shadow" x="-50%" y="-50%" width="200%" height="200%">
                      <feGaussianBlur in="SourceAlpha" stdDeviation="8"/>
                      <feOffset dx="0" dy="4" result="offsetblur"/>
                      <feComponentTransfer>
                        <feFuncA type="linear" slope="0.3"/>
                      </feComponentTransfer>
                      <feMerge>
                        <feMergeNode/>
                        <feMergeNode in="SourceGraphic"/>
                      </feMerge>
                    </filter>
                  </defs>
                  <circle cx="200" cy="200" r="180" fill="url(#mainGradient)" filter="url(#shadow)"/>
                  <g opacity="0.1">
                    <line x1="80" y1="120" x2="320" y2="120" stroke="white" stroke-width="2"/>
                    <line x1="80" y1="160" x2="320" y2="160" stroke="white" stroke-width="2"/>
                    <line x1="80" y1="200" x2="320" y2="200" stroke="white" stroke-width="2"/>
                    <line x1="80" y1="240" x2="320" y2="240" stroke="white" stroke-width="2"/>
                    <line x1="80" y1="280" x2="320" y2="280" stroke="white" stroke-width="2"/>
                  </g>
                  <line x1="100" y1="100" x2="100" y2="300" stroke="#EF4444" stroke-width="3" opacity="0.6"/>
                  <g transform="translate(140, 100) rotate(-30)">
                    <rect x="0" y="0" width="80" height="20" fill="#FCD34D" rx="2"/>
                    <rect x="0" y="0" width="80" height="8" fill="#F59E0B" rx="2"/>
                    <polygon points="80,0 80,20 95,10" fill="#8B4513"/>
                    <polygon points="95,10 100,10 97.5,5 97.5,15" fill="#2D2D2D"/>
                    <rect x="-8" y="3" width="8" height="14" fill="#EC4899" rx="1"/>
                    <rect x="-10" y="8" width="2" height="4" fill="#A855F7"/>
                  </g>
                  <g transform="translate(200, 220)">
                    <circle cx="0" cy="0" r="65" fill="white" opacity="0.95"/>
                    <path d="M -25 -5 L -10 15 L 30 -25" 
                          stroke="url(#checkGradient)" 
                          stroke-width="14" 
                          stroke-linecap="round" 
                          stroke-linejoin="round" 
                          fill="none"/>
                  </g>
                  <g fill="#FBBF24" opacity="0.8">
                    <path d="M 320 100 l 4 12 l 12 4 l -12 4 l -4 12 l -4 -12 l -12 -4 l 12 -4 z"/>
                    <path d="M 90 280 l 3 9 l 9 3 l -9 3 l -3 9 l -3 -9 l -9 -3 l 9 -3 z"/>
                    <path d="M 330 280 l 2.5 7.5 l 7.5 2.5 l -7.5 2.5 l -2.5 7.5 l -2.5 -7.5 l -7.5 -2.5 l 7.5 -2.5 z"/>
                  </g>
                  <text x="80" y="90" font-family="'Arial Black', sans-serif" font-size="36" font-weight="900" fill="white" opacity="0.4">K</text>
                </svg>
                <div class="text-center sm:text-left">
                    <h1 class="text-2xl sm:text-3xl font-bold text-indigo-900">Kumon Homework Checker</h1>
                    <p class="text-sm sm:text-base text-gray-600">Upload answer book and homework photos to check answers automatically</p>
                </div>
            </div>
            
            <!-- Answer Book Section -->
            <div class="mb-8">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3 flex items-center">
                    <span class="bg-green-500 text-white rounded-full w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center mr-2 text-xs sm:text-sm">1</span>
                    <span>Answer Book Library</span>
                    <span class="ml-2 text-xs font-normal text-gray-500 hidden sm:inline">(Save multiple answer books)</span>
                </h2>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
                    <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 sm:p-6 text-center hover:border-indigo-400 transition-colors answer-book-upload-area">
                        <input type="file" id="answerBookInput" accept="image/*" multiple class="hidden" />
                        <label for="answerBookInput" class="cursor-pointer block touch-manipulation">
                            <svg class="mx-auto h-8 sm:h-10 w-8 sm:w-10 text-gray-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M23 19a6 6 0 100 12 6 6 0 000-12zm0 0V9m0 30v10M3 23h8m28 0h8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                <path d="M9 10a2 2 0 012-2h6l2-2h10l2 2h6a2 2 0 012 2v24a2 2 0 01-2 2H11a2 2 0 01-2-2V10z" stroke-width="2" />
                            </svg>
                            <p class="text-sm text-gray-600 font-semibold">Select Photos</p>
                            <p class="text-xs text-gray-500 mt-1">Choose multiple at once</p>
                        </label>
                    </div>
                    
                    <div class="border-2 border-dashed border-indigo-300 rounded-lg p-4 sm:p-6 text-center hover:border-indigo-400 transition-colors cursor-pointer bg-indigo-50">
                        <input type="file" id="importAnswerBookInput" accept=".json" class="hidden" />
                        <label for="importAnswerBookInput" class="cursor-pointer block">
                            <svg class="mx-auto h-8 sm:h-10 w-8 sm:w-10 text-indigo-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                                <path d="M24 4v20m0 0l-8-8m8 8l8-8M4 36v4a4 4 0 004 4h32a4 4 0 004-4v-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <p class="text-sm text-indigo-600 font-semibold">Import Saved</p>
                            <p class="text-xs text-gray-500 mt-1">Upload .json file</p>
                        </label>
                    </div>
                </div>
                
                <div id="answerBookPreview" class="mt-4"></div>
            </div>

            <!-- Homework Section -->
            <div class="mb-8">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-3 flex items-center">
                    <span class="bg-blue-500 text-white rounded-full w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center mr-2 text-xs sm:text-sm">2</span>
                    Student's Homework
                </h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 sm:p-6 text-center hover:border-indigo-400 transition-colors">
                    <input type="file" id="homeworkInput" accept="image/*" multiple class="hidden" />
                    <label for="homeworkInput" class="cursor-pointer touch-manipulation">
                        <svg class="mx-auto h-8 sm:h-12 w-8 sm:w-12 text-gray-400 mb-2 sm:mb-3" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                            <path d="M23 19a6 6 0 100 12 6 6 0 000-12zm0 0V9m0 30v10M3 23h8m28 0h8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M9 10a2 2 0 012-2h6l2-2h10l2 2h6a2 2 0 012 2v24a2 2 0 01-2 2H11a2 2 0 01-2-2V10z" stroke-width="2" />
                        </svg>
                        <p class="text-sm text-gray-600">Select Multiple Photos</p>
                        <p class="text-xs text-gray-500 mt-1">Photos or camera</p>
                    </label>
                </div>
                <div id="homeworkPreview" class="mt-4 grid grid-cols-2 gap-4"></div>
            </div>

            <!-- Check Button -->
            <button id="checkButton" class="w-full bg-indigo-600 hover:bg-indigo-700 active:bg-indigo-800 text-white font-semibold py-3 sm:py-4 px-4 sm:px-6 rounded-lg transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed shadow-lg hover:shadow-xl active:shadow-md text-sm sm:text-base touch-manipulation">
                Check Homework
            </button>

            <!-- Loading State -->
            <div id="loadingState" class="hidden mt-6 text-center">
                <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-3"></div>
                <p class="text-gray-600">Claude is checking the homework...</p>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="hidden mt-8">
                <h2 class="text-lg sm:text-xl font-semibold text-gray-800 mb-4 flex items-center">
                    <span class="bg-purple-500 text-white rounded-full w-7 h-7 sm:w-8 sm:h-8 flex items-center justify-center mr-2 text-xs sm:text-sm">3</span>
                    Results
                </h2>
                <div id="resultsContent" class="bg-gray-50 rounded-lg p-6"></div>
            </div>
        </div>
    </div>

    <script>
        let answerBookFiles = [];
        let homeworkFiles = [];
        let savedAnswerBooks = [];
        let selectedAnswerBookId = null;
        let storageReady = false;
        let apiKey = '';

        // Check for API key on load
        window.addEventListener('DOMContentLoaded', function() {
            apiKey = localStorage.getItem('kumon_api_key') || '';
            if (!apiKey) {
                document.getElementById('apiKeyModal').classList.remove('hidden');
            }
        });

        // Save API key
        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (!key) {
                alert('Please enter your API key');
                return;
            }
            if (!key.startsWith('sk-ant-')) {
                alert('Invalid API key format. It should start with "sk-ant-"');
                return;
            }
            localStorage.setItem('kumon_api_key', key);
            apiKey = key;
            document.getElementById('apiKeyModal').classList.add('hidden');
        }

        // Open settings to change API key
        function openSettings() {
            const newKey = prompt('Enter your new Claude API key:', apiKey);
            if (newKey && newKey.trim()) {
                if (newKey.startsWith('sk-ant-')) {
                    localStorage.setItem('kumon_api_key', newKey.trim());
                    apiKey = newKey.trim();
                    alert('API key updated successfully!');
                } else {
                    alert('Invalid API key format');
                }
            }
        }

        // Initialize app
        async function initializeApp() {
            console.log('Initializing Kumon Homework Checker...');
            await loadSavedAnswerBooks();
            console.log('Loaded', savedAnswerBooks.length, 'saved answer books');
            updateCheckButton();
            
            // Set up answer book input handler
            const answerBookInput = document.getElementById('answerBookInput');
            if (answerBookInput) {
                console.log('Setting up answer book upload handler');
                answerBookInput.addEventListener('change', handleAnswerBookUpload);
            } else {
                console.error('Answer book input not found!');
            }
            
            // Set up import handler
            const importInput = document.getElementById('importAnswerBookInput');
            if (importInput) {
                console.log('Setting up import handler');
                importInput.addEventListener('change', handleImportAnswerBook);
            }
            
            console.log('Initialization complete');
        }

        // Load saved answer books from persistent storage
        async function loadSavedAnswerBooks() {
            if (!window.storage) {
                console.log('Storage not available');
                storageReady = false;
                return;
            }
            
            storageReady = true;
            
            try {
                // Load the list of answer book IDs
                const booksListResult = await window.storage.get('kumon-answer-books-list');
                if (booksListResult && booksListResult.value) {
                    const bookIds = JSON.parse(booksListResult.value);
                    
                    // Load each answer book
                    for (const id of bookIds) {
                        try {
                            const bookResult = await window.storage.get(`kumon-book-${id}`);
                            if (bookResult && bookResult.value) {
                                const book = JSON.parse(bookResult.value);
                                savedAnswerBooks.push(book);
                            }
                        } catch (e) {
                            console.error(`Error loading book ${id}:`, e);
                        }
                    }
                    
                    if (savedAnswerBooks.length > 0) {
                        displayAnswerBookLibrary();
                    }
                }
            } catch (error) {
                console.error('Error loading answer books:', error);
            }
        }

        // Save answer books to persistent storage
        async function saveAnswerBooksToStorage() {
            if (!storageReady || !window.storage) {
                console.log('Storage not ready');
                return;
            }
            
            try {
                // Save the list of book IDs
                const bookIds = savedAnswerBooks.map(b => b.id);
                await window.storage.set('kumon-answer-books-list', JSON.stringify(bookIds));
                
                // Save each answer book individually
                for (const book of savedAnswerBooks) {
                    await window.storage.set(`kumon-book-${book.id}`, JSON.stringify(book));
                }
                
                console.log('Answer books saved successfully');
            } catch (error) {
                console.error('Error saving answer books:', error);
            }
        }

        // Display answer book library
        function displayAnswerBookLibrary() {
            const container = document.getElementById('answerBookPreview');
            container.innerHTML = '';
            
            if (savedAnswerBooks.length > 0) {
                container.innerHTML = '<div class="mb-4"><h3 class="text-sm font-semibold text-gray-700 mb-3">Saved Answer Books</h3></div>';
                
                savedAnswerBooks.forEach((book, index) => {
                    const isSelected = selectedAnswerBookId === book.id;
                    const div = document.createElement('div');
                    div.className = 'mb-4 p-4 border-2 rounded-lg cursor-pointer transition-all ' + 
                                   (isSelected ? 'border-indigo-500 bg-indigo-50' : 'border-gray-200 hover:border-gray-300');
                    
                    div.innerHTML = `
                        <div class="flex items-start gap-2 sm:gap-3">
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center gap-2 mb-2">
                                    ${isSelected ? 
                                        '<svg class="w-4 h-4 sm:w-5 sm:h-5 text-indigo-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>' :
                                        '<svg class="w-4 h-4 sm:w-5 sm:h-5 text-gray-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10" stroke-width="2"></circle></svg>'
                                    }
                                    <input type="text" 
                                           value="${book.name}" 
                                           data-book-id="${book.id}"
                                           class="book-name-input text-sm sm:text-base font-semibold text-gray-800 border-none bg-transparent outline-none focus:bg-white focus:border focus:border-indigo-300 rounded px-1 sm:px-2 py-1 -ml-1 sm:-ml-2 flex-1 min-w-0" />
                                </div>
                                <p class="text-xs text-gray-500 ml-6 sm:ml-7">${book.images.length} photo(s) • ${new Date(book.timestamp).toLocaleDateString()}</p>
                                <div class="flex gap-1 sm:gap-2 mt-2 ml-6 sm:ml-7 flex-wrap">
                                    ${book.images.slice(0, 3).map(img => `
                                        <img src="data:image/jpeg;base64,${img}" class="w-12 h-12 sm:w-16 sm:h-16 object-cover rounded border border-gray-200" />
                                    `).join('')}
                                    ${book.images.length > 3 ? `<div class="w-12 h-12 sm:w-16 sm:h-16 rounded border border-gray-200 flex items-center justify-center bg-gray-100 text-gray-600 text-xs">+${book.images.length - 3}</div>` : ''}
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-1 sm:gap-2 flex-shrink-0">
                                <button class="download-btn text-indigo-600 hover:text-indigo-800 p-1.5 sm:p-2 active:bg-indigo-100 rounded"
                                        data-book-id="${book.id}"
                                        title="Download answer book">
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                    </svg>
                                </button>
                                <button class="delete-btn text-red-500 hover:text-red-700 p-1.5 sm:p-2 active:bg-red-100 rounded"
                                        data-book-id="${book.id}"
                                        title="Delete answer book">
                                    <svg class="w-4 h-4 sm:w-5 sm:h-5 pointer-events-none" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    // Add click handler for selecting answer book
                    div.addEventListener('click', (e) => {
                        // Don't select if clicking on buttons or input
                        if (e.target.closest('button') || e.target.closest('input')) {
                            return;
                        }
                        selectAnswerBook(book.id);
                    });
                    
                    // Add event listeners after adding to DOM
                    container.appendChild(div);
                    
                    // Download button handler
                    const downloadBtn = div.querySelector('.download-btn');
                    if (downloadBtn) {
                        downloadBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            downloadAnswerBook(book.id);
                        });
                    }
                    
                    // Delete button handler
                    const deleteBtn = div.querySelector('.delete-btn');
                    if (deleteBtn) {
                        deleteBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            deleteAnswerBook(book.id);
                        });
                    }
                    
                    // Rename input handler
                    const nameInput = div.querySelector('.book-name-input');
                    if (nameInput) {
                        nameInput.addEventListener('click', (e) => {
                            e.stopPropagation();
                        });
                        nameInput.addEventListener('change', (e) => {
                            renameAnswerBook(book.id, e.target.value);
                        });
                    }
                });
            }

            // Update upload section
            updateUploadSection();
            updateCheckButton();
        }

        // Update upload section UI
        function updateUploadSection() {
            const uploadArea = document.querySelector('.answer-book-upload-area');
            if (!uploadArea) return;
            
            uploadArea.innerHTML = `
                <input type="file" id="answerBookInput" accept="image/*" capture="environment" multiple class="hidden" />
                <label for="answerBookInput" class="cursor-pointer block">
                    <svg class="mx-auto h-10 w-10 text-gray-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                        <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <p class="text-sm text-indigo-600 font-semibold">+ Add New Answer Book</p>
                    <p class="text-xs text-gray-500 mt-1">Take photos or upload • Auto-compressed</p>
                </label>
            `;
            
            // Re-attach event listener
            const input = document.getElementById('answerBookInput');
            if (input) {
                input.addEventListener('change', handleAnswerBookUpload);
            }
        }

        // Select an answer book
        function selectAnswerBook(id) {
            selectedAnswerBookId = id;
            displayAnswerBookLibrary();
        }

        // Rename answer book
        async function renameAnswerBook(id, newName) {
            const book = savedAnswerBooks.find(b => b.id === id);
            if (book) {
                book.name = newName;
                await saveAnswerBooksToStorage();
            }
        }

        // Delete answer book
        async function deleteAnswerBook(id) {
            if (confirm('Are you sure you want to delete this answer book?')) {
                savedAnswerBooks = savedAnswerBooks.filter(b => b.id !== id);
                if (selectedAnswerBookId === id) {
                    selectedAnswerBookId = null;
                }
                
                // Delete from persistent storage
                if (storageReady && window.storage) {
                    try {
                        await window.storage.delete(`kumon-book-${id}`);
                    } catch (e) {
                        console.error('Error deleting from storage:', e);
                    }
                }
                
                await saveAnswerBooksToStorage();
                displayAnswerBookLibrary();
            }
        }

        // Download answer book
        function downloadAnswerBook(id) {
            const book = savedAnswerBooks.find(b => b.id === id);
            if (!book) {
                alert('Answer book not found');
                return;
            }
            
            // Create a download blob
            const dataStr = JSON.stringify(book, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            // Create download link
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `${book.name.replace(/[^a-z0-9]/gi, '_')}_answerbook.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            // Show success message
            const container = document.getElementById('answerBookPreview');
            const message = document.createElement('div');
            message.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            message.textContent = '✓ Answer book downloaded!';
            document.body.appendChild(message);
            setTimeout(() => message.remove(), 3000);
        }

        // Handle import of previously downloaded answer book
        async function handleImportAnswerBook(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const importedBook = JSON.parse(text);
                
                // Validate the imported data
                if (!importedBook.id || !importedBook.name || !importedBook.images || !Array.isArray(importedBook.images)) {
                    throw new Error('Invalid answer book file format');
                }
                
                // Check if book with same ID already exists
                const existingIndex = savedAnswerBooks.findIndex(b => b.id === importedBook.id);
                if (existingIndex !== -1) {
                    if (confirm(`An answer book named "${savedAnswerBooks[existingIndex].name}" already exists. Replace it?`)) {
                        savedAnswerBooks[existingIndex] = importedBook;
                    } else {
                        // Create new ID for the imported book
                        importedBook.id = 'book_' + Date.now();
                        importedBook.name = importedBook.name + ' (imported)';
                        savedAnswerBooks.push(importedBook);
                    }
                } else {
                    savedAnswerBooks.push(importedBook);
                }
                
                selectedAnswerBookId = importedBook.id;
                await saveAnswerBooksToStorage();
                displayAnswerBookLibrary();
                
                // Show success message
                const message = document.createElement('div');
                message.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
                message.textContent = '✓ Answer book imported successfully!';
                document.body.appendChild(message);
                setTimeout(() => message.remove(), 3000);
                
            } catch (error) {
                console.error('Error importing answer book:', error);
                alert('Error importing answer book. Please make sure the file is valid.');
            }
            
            // Reset file input
            e.target.value = '';
        }

        // Handle answer book uploads
        async function handleAnswerBookUpload(e) {
            console.log('Upload triggered, files:', e.target.files.length);
            const files = Array.from(e.target.files);
            
            if (files.length === 0) {
                console.log('No files selected');
                return;
            }

            console.log('Processing', files.length, 'files');

            // Show loading
            const container = document.getElementById('answerBookPreview');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'uploadLoading';
            loadingDiv.className = 'text-center py-4 text-gray-600';
            loadingDiv.innerHTML = '<div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600 mx-auto mb-2"></div><p class="text-sm">Saving answer book...</p>';
            container.appendChild(loadingDiv);
            
            try {
                console.log('Starting base64 conversion...');
                // Convert to base64 and save
                const images = await Promise.all(
                    files.map(file => fileToBase64(file))
                );
                
                console.log('Conversion complete, creating book object');
                
                const newBook = {
                    id: 'book_' + Date.now(),
                    name: `Answer Book ${savedAnswerBooks.length + 1}`,
                    images: images,
                    timestamp: new Date().toISOString()
                };
                
                console.log('Adding to savedAnswerBooks array');
                savedAnswerBooks.push(newBook);
                selectedAnswerBookId = newBook.id;
                
                console.log('Saving to storage...');
                await saveAnswerBooksToStorage();
                
                console.log('Displaying library...');
                displayAnswerBookLibrary();
                
                // Reset file input
                e.target.value = '';
                console.log('Upload complete!');
            } catch (error) {
                console.error('Error uploading answer book:', error);
                alert('Error uploading files: ' + error.message + '\nPlease try again with smaller images or fewer files.');
                
                // Remove loading indicator
                const loading = document.getElementById('uploadLoading');
                if (loading) loading.remove();
                
                displayAnswerBookLibrary();
            }
        }

        // Handle homework uploads
        document.getElementById('homeworkInput').addEventListener('change', function(e) {
            homeworkFiles = Array.from(e.target.files);
            displayPreviews('homeworkPreview', homeworkFiles);
            updateCheckButton();
        });

        // Display image previews
        function displayPreviews(containerId, files) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const div = document.createElement('div');
                    div.className = 'relative group';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="w-full h-48 object-cover rounded-lg shadow-md" />
                        <div class="absolute top-2 right-2 bg-white rounded-full px-2 py-1 text-xs font-semibold shadow">
                            ${index + 1}
                        </div>
                    `;
                    container.appendChild(div);
                };
                reader.readAsDataURL(file);
            });
        }

        // Update check button state
        function updateCheckButton() {
            const button = document.getElementById('checkButton');
            const hasAnswerBook = selectedAnswerBookId !== null;
            button.disabled = !hasAnswerBook || homeworkFiles.length === 0;
            
            if (!hasAnswerBook && savedAnswerBooks.length > 0) {
                button.textContent = 'Select an Answer Book First';
            } else if (!hasAnswerBook) {
                button.textContent = 'Upload Answer Book First';
            } else if (homeworkFiles.length === 0) {
                button.textContent = 'Upload Homework to Check';
            } else {
                button.textContent = 'Check Homework';
            }
        }

        // Handle check homework
        const checkButton = document.getElementById('checkButton');
        if (checkButton) {
            checkButton.addEventListener('click', async function() {
                console.log('Check button clicked!');
                console.log('Selected answer book:', selectedAnswerBookId);
                console.log('Homework files:', homeworkFiles.length);
                console.log('API key set:', !!apiKey);
                
                if (!apiKey) {
                    alert('Please set up your API key first. Click "API Settings" at the top.');
                    document.getElementById('apiKeyModal').classList.remove('hidden');
                    return;
                }
                
                if (!selectedAnswerBookId) {
                    alert('Please select an answer book first by clicking on it.');
                    return;
                }
                
                if (homeworkFiles.length === 0) {
                    alert('Please upload homework photos first.');
                    return;
                }
                
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('resultsSection').classList.add('hidden');
                this.disabled = true;

                try {
                    console.log('Starting homework check...');
                // Get selected answer book images
                const selectedBook = savedAnswerBooks.find(b => b.id === selectedAnswerBookId);
                if (!selectedBook) {
                    throw new Error('Please select an answer book first');
                }
                
                const answerBookImages = selectedBook.images;
                
                // Convert homework images to base64
                const homeworkImages = await Promise.all(
                    homeworkFiles.map(file => fileToBase64(file))
                );

                // Prepare content for API call
                const content = [
                    {
                        type: "text",
                        text: `You are a homework checker for Kumon worksheets. I will provide you with:
1. Photos of the answer book showing the correct answers
2. Photos of the student's completed homework

IMPORTANT INSTRUCTIONS:
- Kumon worksheets have PRINTED questions/problems and HANDWRITTEN student answers
- You must ONLY compare the HANDWRITTEN answers from the student's homework with the correct answers in the answer book
- IGNORE the printed questions - focus only on what the student wrote by hand
- The student's handwriting will look different from the printed text

GRADING RULES - BE STRICT:
- For MATH problems: The numerical answer must be exactly correct
- For ENGLISH/READING problems: 
  * Capitalization MUST match exactly (e.g., "Dog" ≠ "dog")
  * Punctuation MUST match exactly (e.g., "Hello!" ≠ "Hello")
  * Spelling MUST be exact
  * Minor handwriting variations are OK (e.g., slightly different letter forms)
- ANY capitalization error = INCORRECT (✗)
- ANY punctuation error = INCORRECT (✗)
- Missing periods, commas, exclamation marks, question marks = INCORRECT (✗)

Please compare the student's handwritten answers with the answer book and provide:

1. A detailed analysis in this format:
Question 1: [Student's handwritten answer] → [Correct answer] ✓ or ✗
Question 2: [Student's handwritten answer] → [Correct answer] ✓ or ✗
...

For incorrect answers, note the specific error (e.g., "missing period", "lowercase instead of capital", "wrong punctuation")

2. THEN, provide marking coordinates in JSON format. For EACH homework photo, list the approximate positions where marks should be placed. Use this exact format:

MARKING_DATA_START
{
  "photo_1": [
    {"question": 1, "x": 0.5, "y": 0.3, "correct": true, "error": ""},
    {"question": 2, "x": 0.5, "y": 0.5, "correct": false, "error": "missing period"}
  ],
  "photo_2": [
    {"question": 3, "x": 0.5, "y": 0.3, "correct": false, "error": "lowercase 'd' should be 'D'"}
  ]
}
MARKING_DATA_END

Where:
- x and y are decimal values from 0 to 1 representing the relative position on the image (0.5, 0.5 is center)
- correct is true for ✓ and false for ✗
- error is a brief description for incorrect answers (e.g., "missing period", "lowercase instead of capital", "wrong punctuation", "incorrect spelling"). Leave empty "" for correct answers.
- Position the mark near/over each student's handwritten answer
- Keep error descriptions SHORT (3-5 words max)

3. At the end, provide:
- Total correct/incorrect
- Score (e.g., "Score: 8/10")
- Brief comments highlighting common errors (e.g., "Watch capitalization" or "Remember periods")

Here are the answer book photos:`
                    }
                ];

                // Add answer book images
                answerBookImages.forEach((base64Data, index) => {
                    content.push({
                        type: "image",
                        source: {
                            type: "base64",
                            media_type: "image/jpeg",
                            data: base64Data
                        }
                    });
                });

                content.push({
                    type: "text",
                    text: "Here are the student's homework photos:"
                });

                // Add homework images
                homeworkImages.forEach((base64Data, index) => {
                    content.push({
                        type: "image",
                        source: {
                            type: "base64",
                            media_type: "image/jpeg",
                            data: base64Data
                        }
                    });
                });

                // Check if API key is set
                if (!apiKey) {
                    throw new Error('API key not set. Please click API Settings to add your key.');
                }

                // Call Claude API directly from browser
                // This uses a special Anthropic header that allows browser calls
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "x-api-key": apiKey,
                        "anthropic-version": "2023-06-01",
                        "anthropic-dangerous-direct-browser-access": "true"
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 2000,
                        messages: [
                            {
                                role: "user",
                                content: content
                            }
                        ]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error?.message || `API request failed with status ${response.status}`);
                }

                const data = await response.json();
                
                // Display results
                const resultText = data.content
                    .filter(item => item.type === "text")
                    .map(item => item.text)
                    .join("\n");

                displayResults(resultText);

            } catch (error) {
                console.error("Error:", error);
                let errorMessage = error.message;
                
                // Provide helpful context for common errors
                if (error.message.includes('API key not set')) {
                    errorMessage = 'API key not configured. Please click "API Settings" at the top to add your Claude API key.';
                } else if (error.message.includes('401') || error.message.includes('authentication')) {
                    errorMessage = 'Invalid API key. Please check your API key in Settings and make sure it starts with "sk-ant-".';
                } else if (error.message.includes('429')) {
                    errorMessage = 'Rate limit exceeded. Please wait a moment and try again.';
                } else if (error.message.includes('Failed to fetch') || error.message.includes('NetworkError')) {
                    errorMessage = 'Network error. Please check your internet connection and try again.';
                } else if (error.message.includes('insufficient_quota')) {
                    errorMessage = 'Your API account has run out of credits. Please add credits at console.anthropic.com';
                }
                
                document.getElementById('resultsContent').innerHTML = `
                    <div class="bg-red-50 border-l-4 border-red-500 p-4">
                        <div class="flex items-start">
                            <svg class="w-6 h-6 text-red-500 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <p class="font-semibold text-red-800 mb-1">Error checking homework</p>
                                <p class="text-sm text-red-700">${errorMessage}</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('resultsSection').classList.remove('hidden');
            } finally {
                document.getElementById('loadingState').classList.add('hidden');
                this.disabled = false;
            }
        });
        } else {
            console.error('Check button not found!');
        }

        // Display results with formatting
        function displayResults(text) {
            const resultsContent = document.getElementById('resultsContent');
            
            // Extract marking data if present
            let markingData = null;
            let displayText = text;
            
            const markingStart = text.indexOf('MARKING_DATA_START');
            const markingEnd = text.indexOf('MARKING_DATA_END');
            
            if (markingStart !== -1 && markingEnd !== -1) {
                const jsonStr = text.substring(markingStart + 18, markingEnd).trim();
                try {
                    markingData = JSON.parse(jsonStr);
                    displayText = text.substring(0, markingStart) + text.substring(markingEnd + 16);
                } catch (e) {
                    console.error('Error parsing marking data:', e);
                }
            }
            
            // Format the text with proper styling
            const formattedText = displayText
                .replace(/✓/g, '<span class="text-green-600 font-bold text-xl">✓</span>')
                .replace(/✗/g, '<span class="text-red-600 font-bold text-xl">✗</span>')
                .replace(/Score: (\d+\/\d+)/g, '<div class="mt-4 p-4 bg-indigo-100 rounded-lg"><span class="text-2xl font-bold text-indigo-900">Score: $1</span></div>')
                .replace(/\n/g, '<br>');

            let resultsHTML = `
                <div class="prose max-w-none mb-6">
                    ${formattedText}
                </div>
            `;
            
            // Add marked homework images if we have marking data
            if (markingData) {
                resultsHTML += '<h3 class="text-lg font-semibold text-gray-800 mb-3 mt-6">Marked Homework Photos</h3>';
                resultsHTML += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4">';
                
                homeworkFiles.forEach((file, index) => {
                    const photoKey = `photo_${index + 1}`;
                    const marks = markingData[photoKey] || [];
                    
                    resultsHTML += `
                        <div class="relative">
                            <canvas id="markedCanvas_${index}" class="w-full rounded-lg shadow-lg border-2 border-gray-200"></canvas>
                        </div>
                    `;
                });
                
                resultsHTML += '</div>';
            }
            
            resultsContent.innerHTML = resultsHTML;
            
            // Draw marks on canvases
            if (markingData) {
                homeworkFiles.forEach((file, index) => {
                    const photoKey = `photo_${index + 1}`;
                    const marks = markingData[photoKey] || [];
                    drawMarkedImage(file, marks, `markedCanvas_${index}`);
                });
            }
            
            document.getElementById('resultsSection').classList.remove('hidden');
        }

        // Draw image with marks
        function drawMarkedImage(file, marks, canvasId) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() {
                    const canvas = document.getElementById(canvasId);
                    if (!canvas) return;
                    
                    const ctx = canvas.getContext('2d');
                    
                    // Set canvas size to match image
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw original image
                    ctx.drawImage(img, 0, 0);
                    
                    // Draw marks
                    marks.forEach(mark => {
                        const x = mark.x * img.width;
                        const y = mark.y * img.height;
                        const size = 60;
                        
                        // Draw circle background
                        ctx.fillStyle = mark.correct ? 'rgba(16, 185, 129, 0.9)' : 'rgba(239, 68, 68, 0.9)';
                        ctx.beginPath();
                        ctx.arc(x, y, size/2, 0, 2 * Math.PI);
                        ctx.fill();
                        
                        // Draw mark
                        ctx.strokeStyle = 'white';
                        ctx.lineWidth = 8;
                        ctx.lineCap = 'round';
                        ctx.lineJoin = 'round';
                        
                        if (mark.correct) {
                            // Draw checkmark
                            ctx.beginPath();
                            ctx.moveTo(x - size/4, y);
                            ctx.lineTo(x - size/8, y + size/4);
                            ctx.lineTo(x + size/3, y - size/4);
                            ctx.stroke();
                        } else {
                            // Draw X
                            ctx.beginPath();
                            ctx.moveTo(x - size/4, y - size/4);
                            ctx.lineTo(x + size/4, y + size/4);
                            ctx.moveTo(x + size/4, y - size/4);
                            ctx.lineTo(x - size/4, y + size/4);
                            ctx.stroke();
                            
                            // Add error description if available
                            if (mark.error && mark.error.trim() !== '') {
                                // Draw background for error text
                                ctx.font = 'bold 14px Arial';
                                const errorText = mark.error;
                                const textMetrics = ctx.measureText(errorText);
                                const textWidth = textMetrics.width;
                                const textHeight = 20;
                                const padding = 6;
                                
                                // Position error text to the right of the X mark
                                const textX = x + size/2 + 10;
                                const textY = y;
                                
                                // Draw rounded rectangle background
                                ctx.fillStyle = 'rgba(239, 68, 68, 0.95)';
                                ctx.beginPath();
                                ctx.roundRect(textX - padding, textY - textHeight/2 - padding, 
                                             textWidth + padding * 2, textHeight + padding * 2, 4);
                                ctx.fill();
                                
                                // Draw error text
                                ctx.fillStyle = 'white';
                                ctx.textAlign = 'left';
                                ctx.textBaseline = 'middle';
                                ctx.fillText(errorText, textX, textY);
                            }
                        }
                        
                        // Add question number label
                        ctx.fillStyle = 'white';
                        ctx.font = 'bold 16px Arial';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'alphabetic';
                        ctx.fillText(`Q${mark.question}`, x, y + size/2 + 20);
                    });
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // Convert file to base64 with automatic compression
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const img = new Image();
                    img.onload = () => {
                        // Compress image if needed
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;
                        
                        // Max dimensions for storage (reduces file size significantly)
                        const MAX_WIDTH = 2000;
                        const MAX_HEIGHT = 2000;
                        
                        // Calculate new dimensions
                        if (width > height) {
                            if (width > MAX_WIDTH) {
                                height = Math.round((height * MAX_WIDTH) / width);
                                width = MAX_WIDTH;
                            }
                        } else {
                            if (height > MAX_HEIGHT) {
                                width = Math.round((width * MAX_HEIGHT) / height);
                                height = MAX_HEIGHT;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Convert to base64 with compression (0.85 quality)
                        const base64String = canvas.toDataURL('image/jpeg', 0.85).split(',')[1];
                        
                        console.log(`Compressed ${file.name}: ${Math.round(file.size/1024)}KB -> ${Math.round(base64String.length*0.75/1024)}KB`);
                        resolve(base64String);
                    };
                    img.onerror = reject;
                    img.src = reader.result;
                };
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        // Initialize app when page loads
        console.log('Initializing app...');
        initializeApp().then(() => {
            console.log('App initialized successfully');
        }).catch(err => {
            console.error('Initialization error:', err);
        });
    </script>
</body>
</html>
